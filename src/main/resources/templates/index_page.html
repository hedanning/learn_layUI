<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>分页表格</title>


    <link rel="stylesheet"  href="../static/layui/css/layui.css">
    <script type="text/javascript"  src="../static/layui/layui.js"></script>

</head>
<body>
    <!-- 搜索条件 -->
   <div class="demoTable">
       <label class="layui-inline">用户ID</label>
       <div class="layui-inline">
            <input class="layui-input layui-inline" name="id" id="demoReload" autocomplete="off">
        </div>
       <label class="layui-inline">性别</label>
       <div class="layui-inline">
            <div class="layui-inline  layui-form">
                <select name="gender" lay-filter="aihao" id="genderId">
                    <option value="">---请选择---</option>
                    <option value="1">女</option>
                    <option value="2">男</option>
                </select>
            </div>
        </div>
        <button class="layui-btn" data-type="reload" id="idButton">搜索</button>
    </div>





    <!-- 表格 -->
    <table class="layui-hide" id="test" lay-filter="test"></table>
    <!-- 工具栏 -->
    <script type="text/html" id="toolbarDemo">
        <div class="layui-btn-container">
            <button class="layui-btn layui-btn-sm" lay-event="add">添加</button>
            <button class="layui-btn layui-btn-sm" lay-event="delete" data-type="getData">删除</button>
            <button class="layui-btn layui-btn-sm" lay-event="update">编辑</button>
        </div>
    </script>
    <script>
        layui.use(['table','form','jquery'], function(){
            var table = layui.table;
            var form = layui.form;
            var $ = layui.$;

            //表格信息
            table.render({
                elem: '#test'
                ,toolbar: "#toolbarDemo"
                ,method:"get"
                ,contentType: 'jsonp'
                ,height: 500
                ,url: '/employee/' //数据接口
                ,page: true //开启分页
                ,cols: [
                    [ //表头
                        {checkbox: true, fixed: true}
                        ,{field:'id', title: 'id', width:80, sort: true, fixed: true}
                        ,{field: 'name', title: '姓名', width:80}
                        , {field: 'gender', title: '性别', width: 80, templet: function (d) {
                                var t = d.gender;
                                if (t == 1) {
                                    return '女'
                                } else if (t == 2) {
                                    return '男'
                                }
                            }
                        }

                        ,{field: 'salary', title: '薪水', width:80}
                 ]
                ]
                ,id:"tableReload"
            });
            //搜索之后表格重载
            var $ = layui.$,active = {
                reload:function() {
                    //执行重载
                    table.reload('tableReload', {
                        page: {
                            curr: 1  //从第一页开始
                        }
                        , where: {        //传递到后台的条件数据
                            id: $("#demoReload").val(),
                            gender: $("#genderId").val()
                        }
                    })
                }
               /* ,getData:function(){ //获取选中数目
                    var checkStatus = table.checkStatus('test')
                        ,data = checkStatus.data;
                    layer.msg('选中了：'+ data.length + ' 个');
                }*/
            };
            //查询按钮事件
            $('#idButton').on('click', function(){
                active['reload'] ? active['reload'].call(this) : '';
            });
            /*//监听表格复选框选择
            table.on('checkbox(test)', function(obj){
                console.log(obj)
            });*/
            //工具栏监听事件
            table.on("toolbar(test)", function(obj){
                //var checkStatus = table.checkStatus(obj.config.id);
                switch(obj.event){
                    //添加按钮触发的事件
                    case "add":
                        layer.open({
                            //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                            type:1,
                            title:"添加员工",
                            area: ['30%','50%'],
                            content:$("#addPage").html()
                        });
                        //将表单重新渲染，比如：下拉、多选、单选
                        form.render();
                        //监听提交
                        form.on('submit(formDemo)', function(data){
                            $.ajax({
                                url: '/employee/',
                                type: 'POST',
                                data: data.field,   //表单中name属性形成的kay-value
                                //dataType: 'json',
                                success: function (data) {
                                    if (data.success){
                                        top.layer.msg("用户添加成功！", {time:500,end:function () {
                                            parent.location.reload();   //重新加载父页面
                                        }});
                                    }else{
                                        top.layer.msg("添加失败，请重新添加！", {time:500,end:function () {
                                            parent.location.reload();   //重新加载父页面
                                        }});
                                    }
                                }
                            });

                            return false;
                        });
                        break;
                    //删除按钮事件
                    case "delete":
                        //var data = table.checkStatus(obj.config.id);
                        var data = table.checkStatus(obj.config.id).data;
                        var ids=[];
                        for (var i = 0; i < data.length; i++) {
                            ids += data[i].id + ',';
                        }
                        ids = ids.substr(0, ids.length-1);
                        if(data.length<=0){
                            top.layer.msg("请选择要删除的数据");
                        }else{
                            layer.confirm("选择了"+data.length+"个员工，确定要删除吗？", function(index){
                                $.ajax({
                                    url: '/employee/'+ids,
                                    type: 'DELETE',
                                    success: function (data) {
                                        debugger;
                                        if (data.success){
                                            top.layer.msg("删除成功！共删除了"+data.count+"个员工", {time:500,end:function () {
                                                parent.location.reload();   //重新加载父页面
                                            }});
                                        }else{
                                            top.layer.msg("删除失败！", {time:500,end:function () {
                                                parent.location.reload();   //重新加载父页面
                                            }});
                                        }
                                    }
                                });
                                layer.close(index);
                            });
                        }
                        break;
                    case "update":
                        var data = table.checkStatus(obj.config.id).data;
                        layer.open({
                            //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                            type:1,
                            title:"编辑员工信息",
                            area: ['30%','50%'],
                            content:$("#addPage").html()    //addPage需要打开区域的id
                        });
                        setFormValue(data);//动态向表单赋值
                        form.on('submit(formDemo)', function(data){
                            $.ajax({
                                url: '/employee/',
                                type: 'PUT',
                                data:JSON.stringify(data.field),
                                contentType:"application/json; charset=UTF-8",
                                dataType: 'json',
                                success: function (data) {
                                    debugger;
                                    if (data.success){
                                        top.layer.msg("修改成功！", {time:500,end:function () {
                                            parent.location.reload();   //重新加载父页面
                                        }});
                                    }else{
                                        top.layer.msg("修改失败，请重新添加！", {time:500,end:function () {
                                            parent.location.reload();   //重新加载父页面
                                        }});
                                    }
                                }
                            });

                            return false;
                        });
                        break;
                };
            });

            function setFormValue(data){
                form.val("formFilter", {
                    "id":data[0].id
                    ,"name":data[0].name
                    ,"gender":data[0].gender
                    ,"salary":data[0].salary
                });
                form.render(null,'formFilter')
            }
        });



    </script>


    <!-- 添加弹出层 -->
   <div class="layui-row"  id="addPage" style="display:none;">
        <form class="layui-form" lay-filter="formFilter">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">用户id:</label>
                    <div class="layui-input-block">
                        <input type="text" name="id" required  lay-verify="required" placeholder="请输入id" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">姓名:</label>
                    <div class="layui-input-block">
                        <input type="text" name="name" required  lay-verify="required" placeholder="请输入姓名" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-inline">
                    <label class="layui-form-label">性别</label>
                    <div class="layui-input-inline">
                        <select name="gender" id="gender" lay-filter="gender" lay-verify="required">
                            <option value="">----请选择----</option>
                            <option value="1">女</option>
                            <option value="2">男</option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">薪水:</label>
                    <div class="layui-input-block">
                        <input type="text" name="salary" required  lay-verify="required" placeholder="请输入薪水" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <div class="layui-input-block">
                        <button class="layui-btn" lay-submit lay-filter="formDemo">立即提交</button>
                        <button type="reset" class="layui-btn layui-btn-primary" id="resetId">重置</button>
                    </div>
                </div>

            </div>
        </form>
    </div>
</body>
</html>